<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StripeController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JoParis2024</a> &gt; <a href="index.source.html" class="el_package">com.pchab.JoParis2024.controller</a> &gt; <span class="el_source">StripeController.java</span></div><h1>StripeController.java</h1><pre class="source lang-java linenums">package com.pchab.JoParis2024.controller;

import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.sql.Timestamp;
import java.util.Map;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import com.pchab.JoParis2024.pojo.User;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.pchab.JoParis2024.security.payload.request.PaymentRequest;
import com.stripe.Stripe;
import com.stripe.model.checkout.Session;
import com.stripe.param.checkout.SessionCreateParams;

import jakarta.validation.Valid;

@RestController
public class StripeController {

    @Autowired
    private TicketController ticketController;

    @Autowired
    private UserController userController;

    // Clé secrète Stripe (test)
    @Value(&quot;${stripe.secretKey}&quot;)
    private String stripeSecretKey;

    @Value(&quot;${stripe.domain}&quot;)
    private String myDomain;

<span class="fc" id="L44">    public StripeController() {</span>
        // Initialiser Stripe avec la clé secrète
<span class="fc" id="L46">        Stripe.apiKey = stripeSecretKey;</span>
<span class="fc" id="L47">    }</span>

    @PostMapping(&quot;/payment&quot;)
    public Map&lt;String, String&gt; createCheckoutSession(@Valid @RequestBody PaymentRequest paymentRequest, @RequestHeader (value = &quot;Authorization&quot;, required = true) String authorizationHeader) {

<span class="nc" id="L52">        System.out.println(&quot;Initiating Stripe checkout session creation...&quot;);</span>
<span class="nc" id="L53">        System.out.println(&quot;PaymentRequest received: &quot; + paymentRequest);</span>

        // Récupération de l'ID du client (userId)
<span class="nc" id="L56">        ResponseEntity&lt;?&gt; userResponse = userController.getUserFromToken(authorizationHeader);</span>
<span class="nc" id="L57">        User user = (User) userResponse.getBody();</span>
<span class="nc" id="L58">        Long userId = user.getId();</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L60">            throw new RuntimeException(&quot;Utilisateur non authentifié. Veuillez vous connecter.&quot;);</span>
        } else {
<span class="nc" id="L62">            System.out.println(&quot;User authenticated: &quot; + userId);</span>
        }
<span class="nc" id="L64">        System.out.println(&quot;User ID for payment: &quot; + userId);</span>


        try {
<span class="nc" id="L68">            System.out.println(&quot;Received payment request: &quot; + paymentRequest);</span>
            // Domaine de l'application
<span class="nc" id="L70">            String YOUR_DOMAIN = myDomain;</span>

            // Récupérer les informations du produit depuis la requête
<span class="nc" id="L73">            String priceId = paymentRequest.getPriceId();</span>
<span class="nc" id="L74">            Long quantity = paymentRequest.getQuantity();</span>
<span class="nc" id="L75">            Object cart = paymentRequest.getCart();</span>

<span class="nc" id="L77">            System.out.println(&quot;Creating checkout session with priceId: &quot; + priceId + &quot; and quantity: &quot; + quantity);</span>
<span class="nc" id="L78">            Stripe.apiKey = stripeSecretKey;</span>
<span class="nc" id="L79">            System.out.println(&quot;Secret Key: &quot; + Stripe.apiKey);</span>

            // Encoder le message d'erreur pour l'URL
<span class="nc" id="L82">            String errorMessage = &quot;Paiement échoué, veuillez réessayer.&quot;;</span>
<span class="nc" id="L83">            String encodedErrorMessage = URLEncoder.encode(errorMessage, StandardCharsets.UTF_8);           </span>

            // Préparer les données du panier à inclure dans les métadonnées
<span class="nc" id="L86">            Map&lt;String, Object&gt; cartData = Map.of(</span>
            &quot;userId&quot;, userId,
            &quot;cart&quot;, cart
            );
<span class="nc" id="L90">            System.out.println(&quot;Cart Data (JSON) : &quot; + cartData);</span>
            // Créer les paramètres de la session Stripe Checkout
            // Convertir cartData en JSON valide
<span class="nc" id="L93">            ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="nc" id="L94">            String cartJsonString = objectMapper.writeValueAsString(cartData);</span>
<span class="nc" id="L95">            System.out.println(&quot;Cart Data (JSON) : &quot; + cartJsonString);</span>

<span class="nc" id="L97">            SessionCreateParams params = SessionCreateParams.builder()</span>
<span class="nc" id="L98">                    .setMode(SessionCreateParams.Mode.PAYMENT)</span>
<span class="nc" id="L99">                    .setSuccessUrl(YOUR_DOMAIN + &quot;/payment-success?session_id={CHECKOUT_SESSION_ID}&quot;)</span>
<span class="nc" id="L100">                    .setCancelUrl(YOUR_DOMAIN + &quot;/shoppingCart.html?error=&quot; + encodedErrorMessage)</span>
<span class="nc" id="L101">                    .addLineItem(</span>
<span class="nc" id="L102">                            SessionCreateParams.LineItem.builder()</span>
<span class="nc" id="L103">                                    .setQuantity(quantity)</span>
<span class="nc" id="L104">                                    .setPrice(priceId)</span>
<span class="nc" id="L105">                                    .build()</span>
                    )
<span class="nc" id="L107">                    .putMetadata(&quot;cart&quot;, cartJsonString) // Ajouter les métadonnées du panier</span>
<span class="nc" id="L108">                    .build();</span>

            // Créer la session Stripe
<span class="nc" id="L111">            Session session = Session.create(params);</span>

            // Retourner l'URL de la session Stripe Checkout
<span class="nc" id="L114">            System.out.println(&quot;Checkout session created successfully: &quot; + session.getUrl());</span>

<span class="nc" id="L116">            System.out.println(&quot;MAP  = &quot; + Map.of(&quot;url&quot;, session.getUrl()));</span>
            
<span class="nc" id="L118">            return Map.of(&quot;url&quot;, session.getUrl());</span>
<span class="nc" id="L119">        } catch (Exception e) {</span>
<span class="nc" id="L120">            e.printStackTrace();</span>
<span class="nc" id="L121">            throw new RuntimeException(&quot;Erreur lors de la création de la session Stripe : &quot; + e.getMessage());</span>
        }
    }

    @GetMapping(&quot;/payment-success&quot;)
    public ResponseEntity&lt;Void&gt; handlePaymentSuccess(@RequestParam(&quot;session_id&quot;) String sessionId) {

<span class="nc" id="L128">        System.out.println(&quot;Handling payment success for session ID: &quot; + sessionId);</span>
        try {
            // Récupérer les détails de la session Stripe
<span class="nc" id="L131">            Session session = Session.retrieve(sessionId);</span>

            // Récupérer les métadonnées
<span class="nc" id="L134">            Map&lt;String, String&gt; metadata = session.getMetadata();</span>
<span class="nc" id="L135">            System.out.println(&quot;Metadata retrieved: &quot; + metadata);</span>

<span class="nc" id="L137">            String cartJsonString = metadata.get(&quot;cart&quot;); // Récupérer la chaîne JSON</span>

<span class="nc" id="L139">            System.out.println(&quot;Cart JSON String: &quot; + cartJsonString);</span>

            // Convertir la chaîne JSON en objet Java
<span class="nc" id="L142">            ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="nc" id="L143">            Map&lt;String, Object&gt; cartJson = objectMapper.readValue(cartJsonString, Map.class);</span>

            // Extraire le tableau &quot;panier&quot; et &quot;userId&quot;
<span class="nc" id="L146">            Map&lt;String, Object&gt; cart = (Map&lt;String, Object&gt;) cartJson.get(&quot;cart&quot;);</span>
<span class="nc" id="L147">            List&lt;Map&lt;String, Object&gt;&gt; panier = (List&lt;Map&lt;String, Object&gt;&gt;) cart.get(&quot;panier&quot;);</span>
<span class="nc" id="L148">            Long userId = Long.valueOf((Integer) cartJson.get(&quot;userId&quot;) );</span>

            // Afficher les données extraites
<span class="nc" id="L151">            System.out.println(&quot;Panier : &quot; + panier);</span>
<span class="nc" id="L152">            System.out.println(&quot;User ID : &quot; + userId);</span>

            // Enregistrement des tickets en base de données
<span class="nc bnc" id="L155" title="All 2 branches missed.">            for (Map&lt;String, Object&gt; item : panier) {</span>
                /*/
                System.out.println(&quot;Processing item: &quot; + item);
                System.out.println(&quot;Item ID: &quot; + item.get(&quot;id&quot;));
                System.out.println(&quot;Item Type: &quot; + item.get(&quot;type&quot;));
                System.out.println(&quot;Item Quantity: &quot; + item.get(&quot;quantite&quot;));
                */
<span class="nc" id="L162">                Long eventId = Long.parseLong((String) item.get(&quot;id&quot;));</span>
<span class="nc" id="L163">                String ticketType = (String) item.get(&quot;type&quot;);</span>
<span class="nc" id="L164">                Integer quantite = ((Number) item.get(&quot;quantite&quot;)).intValue();</span>

                // Créer un ticket pour chaque élément du panier
<span class="nc bnc" id="L167" title="All 2 branches missed.">                for (int i = 0; i &lt; quantite; i++) {</span>
                    // Récupérer la date et l'heure actuelles
<span class="nc" id="L169">                    Timestamp currentTimestamp = new Timestamp(System.currentTimeMillis());</span>
                    //System.out.println(&quot;Current Timestamp: &quot; + currentTimestamp);
<span class="nc" id="L171">                    ticketController.createTicket(userId, eventId, ticketType, currentTimestamp);</span>
                }
<span class="nc" id="L173">            }</span>
            // Rediriger vers la page HTML dans le dossier static
<span class="nc" id="L175">        return ResponseEntity.status(302).header(&quot;Location&quot;, &quot;/success.html&quot;).build();</span>

<span class="nc" id="L177">        } catch (Exception e) {</span>
<span class="nc" id="L178">            e.printStackTrace();</span>
<span class="nc" id="L179">            throw new RuntimeException(&quot;Erreur lors du traitement du paiement : &quot; + e.getMessage());</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>